<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="X-UA-Compatible" content="ie=edge"> -->
    <title>Range Mapper</title>

    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <script src="https://libs.cartocdn.com/carto-vl/v1.4.4/carto-vl.min.js"></script>

    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css" rel="stylesheet" />
    <!-- <script src="https://libs.cartocdn.com/carto-vl/v1.0.0/carto-vl.min.js"></script> -->
    <link href="https://carto.com/developers/carto-vl/v1.4.4/examples/maps/style.css" rel="stylesheet">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- <link rel="stylesheet" href="https://libs.cartocdn.com/airship-style/v2.4.1/airship.css">
    <script type="module" src="https://libs.cartocdn.com/airship-components/v2.4.1/airship/airship.esm.js"></script>
    <script nomodule="" src="https://libs.cartocdn.com/airship-components/v2.4.1/airship/airship.js"></script>
    <script src="https://libs.cartocdn.com/airship-bridge/v2.4.1/asbridge.js"></script> -->

    <!-- <style>
      .as-map-footer {
        max-width: 812px;
      }
    </style> -->
</head>
<body>
    <div id="map"></div>
    <aside class="toolbox" id="animation-toolbox">
        <div class="box" id="animation-box">
            <header>
                <h1 id="animation-header"> Range Mapper </h1>
            </header>
            <hr/>
            <label for="standard-select"></label>
            <div class="select">
                <select id="standard-select" onchange="setContinent(taxaLayer)">           <!-- dropdown selector -->
                    <!-- <option selected = "selected"></option> -->
                    <option value="northamerica">North America</option>
                    <option value="europe">Europe</option>
                    <option value="oceania">Oceania</option>
                </select>
                <span class="focus"></span>
            </div>
            <hr/>
            <section id="animation-section">
                <p class="animation-rangebar" id="legend-head-text">Years Before Present: <span id="js-current-time" id="open-legend-head-text"></span>
                </p>
            </section>
            <section id="animation-section">
                <p class="animation-rangebar">
                    <button><img id="js-play-pause-button" src="images/pause.png"></button>
                    <input type="range" id="js-progress-range" min="0" max="1" step="0.04">
                </p>
            </section>
            <hr/>
            <section id="animation-section">
                <div class="animation-rangebar">Duration (seconds):
                    <input type="range" id="js-duration-range" min="10" max="60" step="2">
                    <span style="margin-left: 2px" class="open-sans" id="js-duration-span"></span>
                </div>
            </section>
            <hr/>
            <!-- Add legend data -->
            <section>
                <div id="controls">
                    <ul id="content" class="taxa-content"></ul>
                </div>
            </section>
        </div>
    </aside>

    <div id="loader">
        <div class="CDB-LoaderIcon CDB-LoaderIcon--big">
            <svg class="CDB-LoaderIcon-spinner" viewBox="0 0 50 50">
                <circle class="CDB-LoaderIcon-path" cx="25" cy="25" r="20" fill="none"></circle>
            </svg>
        </div>
    </div>

    <!-- Legend -->
    <section class="toolbox">
        <div class="box" id="legend-box">
            <header id="legend-head-text">
                <div>Percent Abundance</div>
            </header>
            <!-- Add legend data -->
            <div id="circ-box">
                <ul id="circ-content" class="legend-content"> </ul>
            </div>
            <div id="logo-div"> <img id="neotoma-logo" src="images/neotoma.jpeg" alt="neotoma">
            </div>
        </div>
    </section>
</div>

<script>
  const s = carto.expressions;
    var continents = ['northamerica', 'europe', 'oceania']
    // var contSource = [`cartoinput_na_3`, `cartoinputeuro`, `cartoinput_aus_2`];
    var contSource = ["cartoinput_na_v6", `cartoinput_euro_v3`, `cartoinput_aus_v3`];
    var allTaxaTypes = [['Alder', 'Ragweed', 'Sedges', 'Beech', 'Spruce', 'Pine', 'Grasses', 'Oak', 'Hemlock', 'Elm'],
                        ['Alder', 'Beech', 'Spruce', 'Oak'], ['She-Oak', 'Eucalyptus', 'Southern Beech', 'Celery Pine', 'Cypress-Pine']];
    var conticeSource = ['na_ice_1', 'euro_ice', '']
    var allExtents = [[-96, 41], [20, 57], [125, -30]]
    var currentExtent = allExtents[0]
    var continentArr = []
    var allPollenSources = []
    var taxaColors = ['#990033', '#FF5733', '#FFC300', '#336699', '#339999', '#996699', '#C7003A', '#FF8D19', '#ADD55C', '#511849'];
    var initialDuration = 31.5
    var allViz = []
    var allLayers = []
    var allToggleableIds = [] // maybe get rid of

    var map = new mapboxgl.Map({
        container: 'map',
        style: carto.basemaps.positron,
        center: currentExtent,
        zoom: 3
    });

    carto.setDefaultAuth({
        username: 'aegeorge2',
        apiKey: '2b8175051e465979cce3424b18b49846d1461e48'

        // username: 'aegeorge2',
        // apiKey: 'heU_1wb2M466etB6mh-UjA'
    });

    const nav = new mapboxgl.NavigationControl();
    map.addControl(nav, 'bottom-left');

    document.getElementById('js-duration-span').innerHTML = initialDuration;

    for (let i = 0; i < continents.length; i++){
        continentArr[i] = [continents[i], contSource[i], conticeSource[i], allTaxaTypes[i]]
    }

    let taxaTypes = continentArr[0][3]
    let taxaSource = new carto.source.Dataset(continentArr[0][1]);

    // setupMap(0)
    const taxaViz = new carto.Viz(`
        @duration: 31.5
        @palette: [#339999, #fad620, #990033, #ff5233, #336699, #996699, #ff9b19, #C7003A, #ADD55C, #511849];
        @animation: animation(linear($time), @duration, fade(@duration/21,@duration/15.5));
        @taxa: $taxa
        @v_histogram: viewportHistogram($taxa)
        @opacity: opacity(ramp(@taxa,@palette), 0.45)
        color: @opacity;
        width: (50*(($samples / 25) ^ 0.5716));
        filter: @animation and @taxa in ['Alder', 'Ragweed', 'Sedges', 'Beech', 'Spruce', 'Pine', 'Grasses', 'Oak', 'Hemlock', 'Elm', 'She-Oak', 'Eucalyptus', 'Southern Beech', 'Celery Pine', 'Cypress-Pine']
        strokeWidth: 0.2;
        strokeColor: opacity(ramp(@taxa,prism),0.2);

    `);
    let euroViz = new carto.Viz(`
        ${commonStyles}
    `);
    let oceaniaViz = new carto.Viz(`
        ${commonStyles}
    `);

    const taxaLayer = new carto.Layer('layer', taxaSource, taxaViz);
    let iceLayer = createIceLayer(0)


//     // Add layers to map
//     // taxaLayer.forEach(currentLayer => {
        taxaLayer.addTo(map);
        iceLayer.addTo(map);
    // });
    // createLegend(0)

    const $playPauseButton = document.getElementById('js-play-pause-button');
    const $durationRange = document.getElementById('js-duration-range');
    const $progressRange = document.getElementById('js-progress-range');
    const $spanDuration = document.getElementById('js-duration-span');
    const $currentTime = document.getElementById('js-current-time');

    const $continentSelection = document.getElementById('continent-selector')


    // getEventListeners()
    // //
    // function getEventListeners() {

    // Save initial time range value
    let last = $progressRange.value;



    // Listen to interaction events
    $durationRange.addEventListener('change', () => {
        const duration = parseInt($durationRange.value, 10);
        // Update animation duration
        taxaViz.variables.duration = $spanDuration.innerHTML = duration
        iceViz.variables.duration = $spanDuration.innerHTML = duration
    });

    $playPauseButton.addEventListener('click', playPause);

    function playPause() {
        paused = taxaViz.variables.animation._paused;
        if (paused) {
            // Play the animation
            taxaViz.variables.animation.play();
            iceViz.variables.animation.play();
            document.getElementById("js-play-pause-button").src="images/pause.png";
        } else  {
            // Pause the animation
            taxaViz.variables.animation.pause();
            iceViz.variables.animation.pause();
            document.getElementById("js-play-pause-button").src="images/play.png";
        }
    };

        $progressRange.addEventListener('change', () => {
            // Update animation progress
            taxaViz.variables.animation.setProgressPct($progressRange.value);
            iceViz.variables.animation.setProgressPct($progressRange.value);
            last = $progressRange.value;
        });

        // Listen to layer events
        taxaLayer.on('updated', () => {
            if ($progressRange.value == last) {
                $progressRange.value = taxaViz.variables.animation.getProgressPct();
                last = $progressRange.value;
            }
            $currentTime.innerText = parseInt(Math.round(taxaViz.variables.animation.getProgressValue()/500)*500);
        });
// }

        var legendSizes = [25,50,100]
        // const widthLegend =
        let widthLegendList = '';
        legendSizes.forEach(currentSize => {
            currentWidth = 50*Math.pow((currentSize/25),0.5716)
            widthLegendList +=
            `<li id="legendList"><div class="circle" id="circle${currentSize}" style="width:${currentWidth}px; height:${currentWidth}px;"></div> ${currentSize}</li>`;
        });
        // Place list items in the content section of the title/legend box
        document.getElementById('circ-content').innerHTML = widthLegendList;


        // When layer loads, trigger legend event
        taxaLayer.on('loaded', () => {
            generateLegend();
            setupWidget();
            hideLoader();
        });

        let initialized = true;

        // When layer loads, trigger legend event
        // playing with when the legend functions individually are used
        taxaLayer.on('updated', () => {
            if (!initialized) {
                generateLegend();
                // setupWidget();
                initialized = true;
            }
    });
        // let initialized = false;

        // taxaLayer.on('updated', () => {
        //     if (!initialized) {
        //
        //         initialized = true;
        //     }
        // });
        // function createViz(){
        //     var taxaViz = new carto.Viz(`
        //         @duration: 30
        //         @animation: animation(linear($time), @duration, fade(1,1))
        //         color: opacity(ramp($taxa,prism),0.45)
        //         width: 100*(($samples/50)^0.5716) * @animation
        //         strokeWidth: 0.2
        //         strokeColor: opacity(ramp($taxa,prism),0.2)
        //     `);
        //     return taxaViz
        // };

        // function createLayer(n){
        //     // var taxaViz = createViz()
        //     var taxaLayer = new carto.Layer('layer', taxaSource, taxaViz);
        //     return taxaLayer
        // }

        function createIceViz(){
            var iceViz = new carto.Viz(`
                @duration:${initialDuration}
                @animation: animation($age,@duration, fade(hold,.15))
                color: opacity(#99daf2,1)
                strokeWidth: 0
                filter: @animation
                `);
            return iceViz
        }

        function createIceLayer(n){
            continentName = continentArr[n][0]
            if (continentName == 'northamerica' || continentName == 'europe'){
                var iceSource = new carto.source.Dataset(continentArr[n][2]);
                iceViz = createIceViz();
                // newViz.push(iceViz);
                const iceLayer = new carto.Layer('icesheets', iceSource, iceViz);
                // newLayer.push(iceLayer);
                return iceLayer
            }
        }

        // function updateMap(){
        //     let selectedContID = document.getElementById('continent-selector');
        //     let continentName = selectedContID.value
        //     if (continentName == 'northamerica') {
        //         n = 0
        //     }
        //     else if (continentName == 'europe') {
        //         n = 1
        //     }
        //     else if (continentName == 'australia') {
        //         n = 2
        //     };
        //     setContinent()
        // }

    taxaLayer.on('loaded', hideLoader);

        function generateLegend() {
            // Request data for legend from the layer viz
            let legend = taxaLayer.viz.color.getLegendData();
            // Create list elements for legend
            console.log(taxaTypes)
            let legendList = legend.data.map((legend, index) => {
                const color = rgbaToHex(legend.value);
                const bordercol = rgbToHex(legend.value)
                const key = legend.key.toLowerCase().replace(' ', '-');
                const selected = taxaTypes.includes(legend.key);
                // Use "js-checkbox" class to get all the checkbox elements from the widget
                // Use "data-taxa-type" attribute to set the category for each checkbox
                return `
                    <li>
                        <input
                            id="js-checkbox-${key}"
                            class="js-checkbox"
                            type="checkbox"
                            name="categories"
                            data-taxa-type="${legend.key}"
                            visible="true"
                        checked>
                        <span class="point-mark" style="background-color:${color}; border: 1px solid ${bordercol}"></span>
                        <label for="js-checkbox-${key}">
                            ${legend.key}
                        </label>
                    </li>\n`;
            }).join('');
            document.getElementById('content').innerHTML = legendList;
        }

        function setupWidget() {
            // 1. Get all the category checkboxes
            const checkboxes = document.getElementsByClassName('js-checkbox');
            // 2. Add an event listener to each category checkbox
            for (let i in checkboxes) {
                const checkbox = checkboxes.item(i);
                checkbox.addEventListener('change', toggleCategory);
            };
        }

        function toggleCategory(event) {
            // 1. Get the clicked checkbox element from the event
            const checkboxElement = event.currentTarget;
            // 2. Get the category through the "data-taxa-type" attribute
            const category = checkboxElement.getAttribute('data-taxa-type');

            // 3. Toggle the chosen category from the global taxaTypes array
            const colorPosition = taxaTypes.indexOf(category)
            const catColor = `${taxaColors[colorPosition]}`
            const newColors = taxaColors
            newColors.splice(colorPosition, 1)
            console.log(taxaTypes)
            taxaTypes = _toggle(taxaTypes, category);

            // 4. Check / uncheck the checkbox element
            checkboxElement.checked = taxaTypes.includes(category);
            // 5. Update the filter
            taxaViz.filter.blendTo(s.and(s.var('animation'),s.in(s.prop('taxa'), taxaTypes)));

            //taxaViz.color.blendTo(s.opacity(s.ramp(s.in(s.prop('taxa'), taxaTypes),s.var('colors')),0));
            taxaViz.variables.animation.setProgressPct(last);
            iceViz.variables.animation.setProgressPct(last);
        }

        //** Helper Methods **//

        // A function to convert map colors to HEX values for legend border color
        function rgbToHex(color) {
            return hex = ("#" + ((1 << 24) + (color.r << 16) + (color.g << 8) + color.b).toString(16).slice(1));
        }

        // A function to convert map colors to HEXA values for legend
        function rgbaToHex(color) {
            hex = ("#" + ((1 << 24) + (color.r << 16) + (color.g << 8) + color.b).toString(16).slice(1));
            a = Math.round(0.60 * 255).toString(16)
            return hex + a;
        }

        // A function to toggle an element in an array
        function _toggle(arr, item) {
            return arr.includes(item) ? arr.filter(i => i !== item) : [...arr, item];
        }

        // function setupMap(n){
        //     var taxaSource = new carto.source.Dataset(continentArr[n][1]);
        //     taxaViz = createViz();
        //     taxaLayer = createLayer(n);
        //     iceLayer = createIceLayer(n);
        //     // taxaLayer = allLayers[n];
        //     // toggleableIds = continentArr[n][2];
        //     // taxaNames = continentArr[n][5];
        //     taxaLayer.addTo(map);
        //     iceLayer.addTo(map);
        //     // return taxaViz
        //     return taxaLayer
        //     // paceLayer.addTo(map);
        //     // last = paceViz.variables.animation.getProgressPct()
        //     // taxaViz.forEach(currentViz => {
        //     //     // Update animation progress
        //     //     currentViz.variables.animation.setProgressPct(paceViz.variables.animation.getProgressPct());
        //     // });
        //     // last = $progressRange.value
        //
        //     // createLegend()
        //
        // };

        // function checkLegendData(){
        //     let selectedContID = document.getElementById('standard-select');
        //     let continentName = selectedContID.value
        //     if (continentName == 'northamerica') {
        //         n = 0
        //     }
        //     else if (continentName == 'europe') {
        //         n = 1
        //     }
        //     else if (continentName == 'oceania') {
        //         n = 2
        //     };
        //     taxaTypes = continentArr[n][3]
        //     // if legend !=== taxaLayer.viz.color.getLegendData();
        //     let legend = taxaLayer.viz.color.getLegendData();
        //
        //     let equal = (legend.data.length === taxaTypes.length);
        //     console.log(taxaLayer.viz)
        //     if (legend.data.length === taxaTypes.length){
        //     //     initialized = false
        //     // };
        //     // if (!initialized) {
        //         // generateLegend();
        //         // setupWidget();
        //         initialized = true;
        //         // console.log(initialized)
        //         stopCheckLegend();
        //         // return initialized;
        //     };
        //     taxaTypes = continentArr[n][3]
        //     // if legend !=== taxaLayer.viz.color.getLegendData();
        //     let legend = taxaLayer.viz.color.getLegendData();
        //
        //     let equal = (legend.data.length === taxaTypes.length);
        //     if (legend.data.length === taxaTypes.length){
        //     //     initialized = false
        //     // };
        //     // if (!initialized) {
        //         // generateLegend();
        //         // setupWidget();
        //         initialized = true;
        //         stopCheckLegend();
        //         // return initialized;
        //     };
        //
        //     return;
        // };
        //
        // function stopCheckLegend(){
        //     taxaLayer.off('updated', checkLegendData)
        // }
        //
        function updateLegend(){
            generateLegend();
            setupWidget();
            // let initialized = false;
            // When layer loads, trigger legend event
            // console.log(initialized)
            // taxaLayer.on('updated', checkLegendData);
            // console.log(initialized);
            // if (initialized){
            //     taxaLayer.off('updated', checkLegendData)
            // }
        };

        // selector.addEventListener("change", setContinent);
        // change sql query with dropdown value
        function setContinent(taxaLayer) {
            let selectedContID = document.getElementById('standard-select');
            let continentName = selectedContID.value
            // taxaLayer.hide()
            if (continentName == 'northamerica') {
                n = 0
                taxaLayer.show()
            }
            else if (continentName == 'europe') {
                n = 1
                // if (typeof euroLayer === 'undefined') {
                // let euroSource = new carto.source.Dataset(continentArr[n][1]);
                // let euroLayer = new carto.Layer('eurolayer', euroSource, euroViz);
                // }
            }
            else if (continentName == 'oceania') {
                n = 2
                // let oceaniaSource = new carto.source.Dataset(continentArr[n][1]);
                // let euroLayer = new carto.Layer('paclayer', oceaniaSource, oceaniaViz);
            };
            taxaTypes = continentArr[n][3]
            if (continentName === 'northamerica' || continentName === 'europe'){
                var iceSource = new carto.source.Dataset(continentArr[n][2]);
                iceLayer.update(iceSource, iceViz);
                iceLayer.show()
            } else {
                iceLayer.hide()
            };

            let taxaSource = new carto.source.Dataset(continentArr[n][1]);
            layerPromise = taxaLayer.update(taxaSource, taxaViz);
            console.log(taxaTypes)
            currentExtent = allExtents[n];
            map.panTo(currentExtent);
            layerPromise.then(updateLegend)
            // let taxaViz = new carto.Viz(`
            //         @duration: 30
            //         @animation: animation(linear($time), @duration, fade(${initialDuration}/21,${initialDuration}/15.5))
            //         color: opacity(ramp($taxa,prism),0.45)
            //         width: 50*(($samples/25)^0.5716) * @animation
            //         strokeWidth: 0.2
            //         strokeColor: opacity(ramp($taxa,prism),0.2)
            //     `);
            // let taxaLayer = new carto.Layer("taxa", taxaSource, taxaViz);
            // taxaLayer.addTo(map);

            // var legEnd = document.getElementById("content");
            // console.log(legEnd)
            // var lis = legEnd.getElementsByTagName("li");
            // console.log(lis[0])
            // for(var i = 0, il = lis.length;i<il;i++) {
            //     legEnd.removeChild(lis[i]);
            // }
            // while( legEnd.firstChild ){
            //   legEnd.removeChild( legEnd.firstChild );
            // }
            console.log()
            // getEventListeners()

            // let initialized = false;
            // return initialized;
            // // When layer loads, trigger legend event
            // taxaLayer.on('loaded', () => {
            //     if (!initialized) {
            //         generateLegend();
            //         setupWidget();
            //         initialized = true;
            //     }
            // });
            // let legend = taxaLayer.viz.color.getLegendData();

            let initialized = false;
            // checkLegendData()
            // updateLegend()
            // return taxaTypes
            // taxaLayer.on('updated', checkLegendData(taxaTypes))
            // if (initialized){
            //     taxaLayer.off('updated', checkLegendData(taxaTypes))
            // }
            generateLegend();
            setupWidget();
        };

        function hideLoader() {
            document.getElementById('loader').style.opacity = '0';
        }


        </script>

    </body>

    </html>
